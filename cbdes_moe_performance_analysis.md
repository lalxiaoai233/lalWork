# CBDES MoE vs BEVFusion æ€§èƒ½å¯¹æ¯”åˆ†ææŠ¥å‘Š

## ä¸€ã€æ€§èƒ½å¯¹æ¯”æ€»ç»“

### 1.1 æ•´ä½“æŒ‡æ ‡å¯¹æ¯”

| æŒ‡æ ‡ | BEVFusion (Epoch 2) | CBDES MoE (Epoch 4) | å·®å¼‚ | å˜åŒ–ç‡ |
|------|---------------------|---------------------|------|--------|
| **mAP@0.5m** | 0.6368 | 0.4977 | **-0.1391** | **-21.8%** |
| **NDS** | 0.52116 | 0.46951 | **-0.05165** | **-9.9%** |
| **mAP (map)** | 0.47146 | 0.38811 | **-0.08335** | **-17.7%** |

### 1.2 å„ç±»åˆ«AP@0.5mè¯¦ç»†å¯¹æ¯”

| ç±»åˆ« | BEVFusion | CBDES MoE | å·®å¼‚ | å˜åŒ–ç‡ | ä¸¥é‡ç¨‹åº¦ |
|------|-----------|-----------|------|--------|----------|
| **car** | 0.7795 | 0.6955 | -0.0840 | -10.8% | âš ï¸ ä¸­ç­‰ |
| **truck** | 0.7108 | 0.3715 | -0.3393 | **-47.7%** | ğŸ”´ **ä¸¥é‡** |
| **bus** | 0.9912 | 0.9487 | -0.0425 | -4.3% | âœ… è½»å¾® |
| **motorcycle** | 0.4511 | 0.3341 | -0.1170 | -25.9% | âš ï¸ ä¸­ç­‰ |
| **bicycle** | 0.1316 | 0.1547 | +0.0231 | +17.6% | âœ… æ”¹å–„ |
| **pedestrian** | 0.8925 | 0.8324 | -0.0601 | -6.7% | âš ï¸ è½»å¾® |
| **traffic_cone** | 0.5007 | 0.1467 | -0.3540 | **-70.7%** | ğŸ”´ **ä¸¥é‡** |

### 1.3 å…³é”®å‘ç°

1. **ä¸¥é‡ä¸‹é™çš„ç±»åˆ«**ï¼š
   - `traffic_cone`: ä¸‹é™70.7%ï¼ˆæœ€ä¸¥é‡ï¼‰
   - `truck`: ä¸‹é™47.7%
   - `motorcycle`: ä¸‹é™25.9%

2. **è½»å¾®ä¸‹é™çš„ç±»åˆ«**ï¼š
   - `car`: ä¸‹é™10.8%
   - `pedestrian`: ä¸‹é™6.7%
   - `bus`: ä¸‹é™4.3%

3. **å”¯ä¸€æ”¹å–„çš„ç±»åˆ«**ï¼š
   - `bicycle`: æå‡17.6%ï¼ˆä½†åŸºæ•°å¾ˆå°ï¼‰

---

## äºŒã€é—®é¢˜æ ¹æºåˆ†æ

### 2.1 è·¯ç”±æŸå¤±è¿‡å¤§é—®é¢˜ âš ï¸ **æ ¸å¿ƒé—®é¢˜**

**ç°è±¡**ï¼š
- è·¯ç”±æŸå¤±ï¼ˆrouting_lossï¼‰ä¸€ç›´ç»´æŒåœ¨ **0.998** å·¦å³ï¼Œå‡ ä¹æ²¡æœ‰ä¸‹é™
- è·¯ç”±æŸå¤±å æ€»æŸå¤±çš„ **30-50%**ï¼Œä¸¥é‡å¹²æ‰°ä¸»ä»»åŠ¡è®­ç»ƒ
- ä»è®­ç»ƒæ—¥å¿—çœ‹ï¼Œè·¯ç”±æŸå¤±ä» epoch 1 çš„ 0.869 ä¸Šå‡åˆ° epoch 6 çš„ 0.998

**ä»£ç ä½ç½®**ï¼š
```python
# mmdet3d/models/fusion_models/cbdes_bevfusion.py:637
outputs['routing_loss'] = routing_loss  # æ²¡æœ‰æƒé‡æ§åˆ¶ï¼
```

**é—®é¢˜**ï¼š
- è·¯ç”±æŸå¤±ç›´æ¥åŠ å…¥æ€»æŸå¤±ï¼Œ**æ²¡æœ‰æƒé‡ç¼©æ”¾**
- è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—å…¬å¼ï¼š`torch.var(expert_probs) * self.num_experts`
- å½“ä¸“å®¶ä½¿ç”¨ä¸å‡è¡¡æ—¶ï¼Œæ–¹å·®å¯èƒ½å¾ˆå¤§ï¼Œå¯¼è‡´è·¯ç”±æŸå¤±è¿‡å¤§

### 2.2 ä¸“å®¶èåˆæ–¹å¼é—®é¢˜

**å½“å‰å®ç°**ï¼š
```python
# mmdet3d/models/backbones/cbdes_moe.py:836-845
weighted_features = None
for j, name in enumerate(expert_names):
    expert_feat = aligned_feats[j]
    weight = expert_weights[:, j:j+1].unsqueeze(-1).unsqueeze(-1)
    if weighted_features is None:
        weighted_features = weight * expert_feat
    else:
        weighted_features += weight * expert_feat
```

**æ½œåœ¨é—®é¢˜**ï¼š
1. **è½¯è·¯ç”±ï¼ˆSoft Routingï¼‰**ï¼šæ‰€æœ‰ä¸“å®¶éƒ½å‚ä¸è®¡ç®—ï¼Œå¯èƒ½å¯¼è‡´ç‰¹å¾æ··åˆä¸ç†æƒ³
2. **æƒé‡å¯èƒ½è¿‡äºå‡åŒ€**ï¼šå¦‚æœè·¯ç”±å™¨æ²¡æœ‰å­¦ä¼šæœ‰æ•ˆé€‰æ‹©ï¼Œæ‰€æœ‰ä¸“å®¶æƒé‡æ¥è¿‘ï¼ˆ0.25ï¼‰ï¼Œç›¸å½“äºç®€å•å¹³å‡
3. **ç‰¹å¾å¯¹é½é—®é¢˜**ï¼šä¸åŒä¸“å®¶çš„ç‰¹å¾ç©ºé—´å¯èƒ½ä¸å…¼å®¹ï¼Œç®€å•åŠ æƒå¯èƒ½ä¸æ˜¯æœ€ä¼˜

### 2.3 ä¸“å®¶åˆ©ç”¨ç‡ä¸å‡è¡¡

**è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—**ï¼š
```python
# mmdet3d/models/backbones/cbdes_moe.py:562-564
expert_probs = self.expert_counts / (self.total_samples + 1e-8)
load_balance_loss = torch.var(expert_probs) * self.num_experts
```

**é—®é¢˜**ï¼š
- å¦‚æœæŸäº›ä¸“å®¶è¢«è¿‡åº¦ä½¿ç”¨ï¼Œæ–¹å·®ä¼šå¾ˆå¤§
- è·¯ç”±æŸå¤±ä¼šæŒç»­å¾ˆé«˜ï¼Œå¯¼è‡´è®­ç»ƒä¸ç¨³å®š
- å¯èƒ½å½¢æˆ"ä¸“å®¶å¡Œé™·"ï¼šæŸäº›ä¸“å®¶è¢«å¿½ç•¥

### 2.4 è®­ç»ƒä¸å……åˆ†

**å¯¹æ¯”**ï¼š
- BEVFusion: Epoch 2 å°±è¾¾åˆ°äº† 0.6368 mAP
- CBDES MoE: Epoch 4 åªæœ‰ 0.4977 mAP

**å¯èƒ½åŸå› **ï¼š
1. è·¯ç”±æŸå¤±å¹²æ‰°å¯¼è‡´ä¸»ä»»åŠ¡å­¦ä¹ ç¼“æ…¢
2. 4ä¸ªä¸“å®¶ç½‘ç»œéœ€è¦æ›´å¤šè®­ç»ƒæ‰èƒ½æ”¶æ•›
3. ä¸“å®¶ä¹‹é—´çš„åä½œéœ€è¦æ—¶é—´å­¦ä¹ 

### 2.5 è¾“å‡ºæŠ•å½±å¯èƒ½ä¸¢å¤±ä¿¡æ¯

**å½“å‰å®ç°**ï¼š
```python
# mmdet3d/models/backbones/cbdes_moe.py:799-801
projection = nn.Sequential(
    nn.Conv2d(actual_dim, self.target_dim, 1)  # 1x1å·ç§¯æŠ•å½±åˆ°256
)
```

**é—®é¢˜**ï¼š
- ç®€å•çš„1x1å·ç§¯å¯èƒ½æ— æ³•å……åˆ†ä¿ç•™ä¸“å®¶ç‰¹å¾
- ä¸åŒä¸“å®¶çš„ç‰¹å¾ç»´åº¦å·®å¼‚å¾ˆå¤§ï¼ˆ96-768ï¼‰ï¼Œå‹ç¼©åˆ°256å¯èƒ½ä¸¢å¤±ä¿¡æ¯
- æ²¡æœ‰è€ƒè™‘ä¸“å®¶ç‰¹å¾çš„äº’è¡¥æ€§

---

## ä¸‰ã€æ”¹è¿›å»ºè®®

### 3.1 æ·»åŠ è·¯ç”±æŸå¤±æƒé‡ï¼ˆ**æœ€ä¼˜å…ˆ**ï¼‰ğŸ”´

**é—®é¢˜**ï¼šè·¯ç”±æŸå¤±æ²¡æœ‰æƒé‡æ§åˆ¶ï¼Œç›´æ¥åŠ å…¥æ€»æŸå¤±

**è§£å†³æ–¹æ¡ˆ**ï¼š
```python
# mmdet3d/models/fusion_models/cbdes_bevfusion.py
# åœ¨ __init__ ä¸­æ·»åŠ 
self.routing_loss_weight = 0.01  # æˆ–ä»é…ç½®è¯»å–

# åœ¨ forward_single ä¸­ä¿®æ”¹
if self.routing_losses:
    routing_loss = sum(self.routing_losses) / len(self.routing_losses)
    outputs['routing_loss'] = routing_loss * self.routing_loss_weight  # æ·»åŠ æƒé‡
```

**å»ºè®®æƒé‡**ï¼š
- åˆå§‹ï¼š0.01ï¼ˆå‚è€ƒ `run_cbdes_training.py:307`ï¼‰
- å¯ä»¥æ ¹æ®è®­ç»ƒè¿›åº¦åŠ¨æ€è°ƒæ•´ï¼šå‰æœŸ0.01ï¼ŒåæœŸ0.001

### 3.2 æ”¹è¿›è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—

**å½“å‰é—®é¢˜**ï¼šæ–¹å·®ä¹˜ä»¥ä¸“å®¶æ•°é‡ï¼Œå¯èƒ½å¯¼è‡´æŸå¤±è¿‡å¤§

**æ”¹è¿›æ–¹æ¡ˆ**ï¼š
```python
# mmdet3d/models/backbones/cbdes_moe.py
def _compute_load_balance_loss(self, expert_weights):
    if not self.training:
        return torch.tensor(0.0, device=expert_weights.device)
    
    # ä½¿ç”¨å½“å‰batchçš„æƒé‡ï¼Œè€Œä¸æ˜¯ç´¯ç§¯è®¡æ•°
    batch_expert_probs = expert_weights.mean(dim=0)  # (num_experts,)
    
    # è®¡ç®—ä¸å‡åŒ€åˆ†å¸ƒçš„KLæ•£åº¦ï¼ˆæ›´ç¨³å®šï¼‰
    uniform_prob = 1.0 / self.num_experts
    kl_loss = F.kl_div(
        F.log_softmax(batch_expert_probs, dim=0),
        torch.full_like(batch_expert_probs, uniform_prob).log(),
        reduction='sum'
    )
    
    # æˆ–è€…ä½¿ç”¨æ›´æ¸©å’Œçš„æ–¹å·®è®¡ç®—
    load_balance_loss = torch.var(batch_expert_probs)  # ä¸ä¹˜ä»¥num_experts
    
    return load_balance_loss
```

### 3.3 æ”¹è¿›ä¸“å®¶èåˆç­–ç•¥

**æ–¹æ¡ˆ1ï¼šç¡¬è·¯ç”±ï¼ˆTop-Kï¼‰**
```python
# åªä½¿ç”¨æƒé‡æœ€å¤§çš„Kä¸ªä¸“å®¶ï¼ˆå¦‚K=2ï¼‰
top_k = 2
topk_weights, topk_indices = torch.topk(expert_weights, k=top_k, dim=-1)
topk_weights = F.softmax(topk_weights, dim=-1)  # é‡æ–°å½’ä¸€åŒ–

# åªèåˆTop-Kä¸“å®¶
weighted_features = None
for k in range(top_k):
    idx = topk_indices[:, k]
    weight = topk_weights[:, k:k+1].unsqueeze(-1).unsqueeze(-1)
    expert_feat = aligned_feats[idx]
    if weighted_features is None:
        weighted_features = weight * expert_feat
    else:
        weighted_features += weight * expert_feat
```

**æ–¹æ¡ˆ2ï¼šé—¨æ§æœºåˆ¶**
```python
# æ·»åŠ å¯å­¦ä¹ çš„é—¨æ§ç½‘ç»œï¼Œå­¦ä¹ å¦‚ä½•èåˆä¸“å®¶ç‰¹å¾
self.gate = nn.Sequential(
    nn.Conv2d(target_dim * num_experts, target_dim, 1),
    nn.Sigmoid()
)

# æ‹¼æ¥æ‰€æœ‰ä¸“å®¶ç‰¹å¾
concat_feats = torch.cat(aligned_feats, dim=1)  # (B, C*N, H, W)
gate_weights = self.gate(concat_feats)  # (B, C, H, W)
weighted_features = gate_weights * weighted_features
```

### 3.4 æ”¹è¿›è¾“å‡ºæŠ•å½±

**å½“å‰**ï¼šç®€å•çš„1x1å·ç§¯

**æ”¹è¿›**ï¼šä½¿ç”¨æ›´å¤æ‚çš„æŠ•å½±ç½‘ç»œ
```python
projection = nn.Sequential(
    nn.Conv2d(actual_dim, self.target_dim * 2, 1),
    nn.BatchNorm2d(self.target_dim * 2),
    nn.ReLU(inplace=True),
    nn.Conv2d(self.target_dim * 2, self.target_dim, 1),
    nn.BatchNorm2d(self.target_dim)
)
```

### 3.5 æ·»åŠ ä¸“å®¶åˆ©ç”¨ç‡ç›‘æ§

**æ·»åŠ æ—¥å¿—**ï¼š
```python
# åœ¨è®­ç»ƒå¾ªç¯ä¸­è®°å½•ä¸“å®¶åˆ©ç”¨ç‡
expert_utilization = expert_weights.mean(dim=0).cpu().numpy()
logger.info(f"Expert utilization: {expert_utilization}")
```

### 3.6 è°ƒæ•´è®­ç»ƒç­–ç•¥

1. **å¢åŠ è®­ç»ƒè½®æ•°**ï¼šMoEæ¨¡å‹éœ€è¦æ›´å¤šè®­ç»ƒæ‰èƒ½æ”¶æ•›
2. **å­¦ä¹ ç‡è°ƒåº¦**ï¼šä¸ºè·¯ç”±å™¨ä½¿ç”¨ä¸åŒçš„å­¦ä¹ ç‡ï¼ˆé€šå¸¸æ›´å°ï¼‰
3. **é¢„çƒ­é˜¶æ®µ**ï¼šå‰å‡ ä¸ªepochä¸ä½¿ç”¨è·¯ç”±æŸå¤±ï¼Œè®©ä¸“å®¶å…ˆå­¦ä¹ åŸºç¡€ç‰¹å¾

---

## å››ã€ä¼˜å…ˆçº§æ’åº

### ğŸ”´ é«˜ä¼˜å…ˆçº§ï¼ˆå¿…é¡»ä¿®å¤ï¼‰

1. **æ·»åŠ è·¯ç”±æŸå¤±æƒé‡**ï¼ˆ3.1ï¼‰
   - å½±å“ï¼šç›´æ¥è§£å†³è·¯ç”±æŸå¤±è¿‡å¤§é—®é¢˜
   - éš¾åº¦ï¼šä½
   - é¢„æœŸæå‡ï¼š+5-10% mAP

2. **æ”¹è¿›è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—**ï¼ˆ3.2ï¼‰
   - å½±å“ï¼šç¨³å®šè®­ç»ƒï¼Œå‡å°‘è·¯ç”±æŸå¤±å¹²æ‰°
   - éš¾åº¦ï¼šä¸­
   - é¢„æœŸæå‡ï¼š+3-5% mAP

### ğŸŸ¡ ä¸­ä¼˜å…ˆçº§ï¼ˆå»ºè®®å®æ–½ï¼‰

3. **æ”¹è¿›ä¸“å®¶èåˆç­–ç•¥**ï¼ˆ3.3ï¼‰
   - å½±å“ï¼šæå‡ç‰¹å¾èåˆè´¨é‡
   - éš¾åº¦ï¼šä¸­
   - é¢„æœŸæå‡ï¼š+2-5% mAP

4. **æ”¹è¿›è¾“å‡ºæŠ•å½±**ï¼ˆ3.4ï¼‰
   - å½±å“ï¼šä¿ç•™æ›´å¤šä¸“å®¶ç‰¹å¾ä¿¡æ¯
   - éš¾åº¦ï¼šä½
   - é¢„æœŸæå‡ï¼š+1-3% mAP

### ğŸŸ¢ ä½ä¼˜å…ˆçº§ï¼ˆå¯é€‰ä¼˜åŒ–ï¼‰

5. **æ·»åŠ ä¸“å®¶åˆ©ç”¨ç‡ç›‘æ§**ï¼ˆ3.5ï¼‰
   - å½±å“ï¼šä¾¿äºè°ƒè¯•å’Œåˆ†æ
   - éš¾åº¦ï¼šä½

6. **è°ƒæ•´è®­ç»ƒç­–ç•¥**ï¼ˆ3.6ï¼‰
   - å½±å“ï¼šé•¿æœŸè®­ç»ƒæ•ˆæœ
   - éš¾åº¦ï¼šä¸­

---

## äº”ã€é¢„æœŸæ”¹è¿›æ•ˆæœ

å¦‚æœå®æ–½æ‰€æœ‰é«˜ä¼˜å…ˆçº§æ”¹è¿›ï¼š
- **é¢„æœŸmAPæå‡**ï¼š+8-15%ï¼ˆä»0.4977æå‡åˆ°0.54-0.57ï¼‰
- **é¢„æœŸNDSæå‡**ï¼š+5-10%ï¼ˆä»0.46951æå‡åˆ°0.49-0.52ï¼‰
- **ä»å¯èƒ½ä½äºBEVFusion**ï¼Œä½†å·®è·ä¼šæ˜¾è‘—ç¼©å°

**æ³¨æ„**ï¼šMoEæ¨¡å‹æœ¬èº«æ›´å¤æ‚ï¼Œéœ€è¦æ›´å¤šè®­ç»ƒæ‰èƒ½å‘æŒ¥ä¼˜åŠ¿ã€‚å¦‚æœè®­ç»ƒå……åˆ†ï¼ˆå¦‚10+ epochsï¼‰ï¼Œå¯èƒ½è¾¾åˆ°æˆ–è¶…è¿‡BEVFusionçš„æ€§èƒ½ã€‚

---

## å…­ã€å®æ–½æ­¥éª¤

1. **ç¬¬ä¸€æ­¥**ï¼šæ·»åŠ è·¯ç”±æŸå¤±æƒé‡ï¼ˆæœ€å¿«è§æ•ˆï¼‰
2. **ç¬¬äºŒæ­¥**ï¼šæ”¹è¿›è´Ÿè½½å‡è¡¡æŸå¤±è®¡ç®—
3. **ç¬¬ä¸‰æ­¥**ï¼šé‡æ–°è®­ç»ƒå¹¶ç›‘æ§ä¸“å®¶åˆ©ç”¨ç‡
4. **ç¬¬å››æ­¥**ï¼šæ ¹æ®ç»“æœå†³å®šæ˜¯å¦å®æ–½å…¶ä»–æ”¹è¿›

---

**ç”Ÿæˆæ—¶é—´**ï¼š2025-01-17
**åˆ†æåŸºäº**ï¼štrain_result/20251116_211721.log.json (CBDES MoE) vs train_result/lal-record (BEVFusion)

